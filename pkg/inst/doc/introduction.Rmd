Introduction to adrminer
========================================================


Installing the package
------------------------
Installing `ADRminer` should be rather straightforward. `ADRminer` relies on several R packages which should be automatically downloading when installing it. The only exception is LBE which is held on the Bioconductor repository and that can be install with the following command:

```{r, eval=FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("LBE")

install.packages("`ADRminer`")
```

From data.frames to ADRminer objects
--------------------------------------------------------
All functions implemented in `ADRminer` relie on two ADRminer S4 objects: pvCont and pvInd. Briefly, pvCont contain aggregated pharmacovigilance data, *i.e.* number of spontaneous reports associated with adverse drug - events pairs. By contrast, if dealing with data at individual level, pvInd should be prefered, especially if one is interested in including individual convariates in the analysis.
`ADRminer` includes toy datasets which will be used throughout this tutorial to illustrate its functionnalities

### Creating a pvInd object

Let's start with sr1 which takes the form of a 3 column data.frame
```{r}
library(`ADRminer`) ### load `ADRminer`

data(sr1)
head(sr1)
```
These are
* a patient identifier for the ADR
* the corresponding drug label 
* the corresponding adverse event label

This dataset can be easily transformed into an pvInd object
```{r}
pvIndSr1 <- pvInd(adr=sr1)
pvIndSr1
names(pvIndSr1)
```

Typing pvIndSR1 into the console (equivalent to show(pvIndSR1) only display a summary of the object created. This object is made of 
* two (sparse) matrices, *i.e.* the drug matrix and the ae event matrix, 
* the drug and ae count margin,

Using the `names` function list the slots of the `pvIndSR1` object.

pvInd object was created in order to handle additionnal individual covariates which makes it possible to run stratified analyses. This covariate dataset should include a patient identifier in the first column. Note that the identifier for both adr and covariates data do not need to match exactly: patients in the covariate dataset but not in the adr dataset will be removed whereas missing value will be added for patient only present in the adr dataset.

The covariates that will be used for conducting stratified analyses should be converted into factors and it is advised to do so before converting the raw data into a pvInd object. For instance in covSr1, neither sex nor age is a factor

```{r}
data(covSr1)
head(covSr1)
class(covSr1$sex)
class(covSr1$age)
```

Converting sex is straightforward
```{r}
covSr1$sexFactor <- factor(covSr1$sex, exclude=NULL) ## exclude=NULL allows to consider NA values as a factor level
summary(covSr1$sexFact)
nlevels(covSr1$sexFact)
head(covSr1)
```

In order to transform age into a categorical variable, one can use the cut() command
```{r}
covSr1$ageFactor <- cut(covSr1$age, breaks=c(0,3,10,18,40,65,110), include.lowest=T)
covSr1$ageFactor <- factor(covSr1$ageFactor, exclude=NULL)
summary(covSr1$ageFactor)
```

Now, we are ready to create a pvInd object including covariate information
```{r}
pvIndSr1 <- pvInd(adr=sr1, cov=covSr1)
pvIndSr3 <- pvInd(adr=sr1)
pvIndSr1
```

### Creating a pvCont object
ADRminer also handle aggregated data. The corresponding ADRminer object is pvCont which can be prefered to pvInd when using disproportionality methods (without stratification) as it is less memory (RAM) demanding.
The easiest way to build a pvCont object is to use as input a 3 column data.frame with
* the drug label
* the ae label
* the number of adr for the corresponding pair

```{r}
data(sr2)
pvContSr2 <- pvCont(sr2)
#res2 <- gps(pvContSr2)
#print(res2$convergence)
#res1 <- gps(pvIndSr1)
#print(res1)
#res3 <- gps(pvIndSr3)
#print(res3)
```


### Object manipulation

#### Removing ae and/or drug with too few data support

pvIndResize can be used to remove drugs for which the marginal number of reports, *i.e.* the total number of reports in which the drug is involved is less than a given number. The same can be done for removing rare ae.

```{r}
pvIndSr1Red <- pvIndResize(pvIndSr1, aeMarginMin=100, dMarginMin=50)
pvIndSr1Red
```

Stratified analyses with disproportionnality methods
--------------------------------------------------------



```{r}
toto <- pvPen(pvIndSr1, cov=c("sexFactor","ageFactor"))
plot(toto)
```

